# é¡¹ç›®ç”Ÿæˆæ€»ç»“æŠ¥å‘Š

## âœ… ç”Ÿæˆå®Œæˆ

æ‚¨è¦æ±‚çš„å®Œæ•´æœ€å°å¯å¤ç°å®éªŒé¡¹ç›®å·²æˆåŠŸç”Ÿæˆï¼

**é¡¹ç›®è·¯å¾„**ï¼š`/data1/shenth/work/MI_plasticity/minimal-exp`

---

## ğŸ“¦ ç”Ÿæˆå†…å®¹æ¦‚è§ˆ

### æ–‡ä»¶ç»Ÿè®¡
- **æ€»æ–‡ä»¶æ•°**ï¼š26 ä¸ª
- **Python æ–‡ä»¶**ï¼š16 ä¸ªï¼ˆå« 6 ä¸ª __init__.pyï¼‰
- **Shell è„šæœ¬**ï¼š3 ä¸ªï¼ˆå¯æ‰§è¡Œï¼‰
- **æ–‡æ¡£æ–‡ä»¶**ï¼š4 ä¸ªï¼ˆå®Œæ•´è¯¦å°½ï¼‰
- **é…ç½®æ–‡ä»¶**ï¼š3 ä¸ª

### æ ¸å¿ƒåŠŸèƒ½
âœ… **æ•°æ®åŠ è½½**ï¼šMNLI åœ¨çº¿åŠ è½½ï¼Œè‡ªåŠ¨ tokenization  
âœ… **æ¨¡å‹è®­ç»ƒ**ï¼šDeBERTa-v3-base å…¨é‡å¾®è°ƒï¼Œè‡ªåŠ¨ç²¾åº¦é€‰æ‹©  
âœ… **é‡è¦æ€§æµ‹é‡**ï¼šHead-level ablationï¼ˆå¾®è°ƒå‰åï¼‰  
âœ… **å¯å¡‘æ€§æµ‹é‡**ï¼šæ¢¯åº¦ä¸ Fisher proxy  
âœ… **æ›´æ–°é‡è®¡ç®—**ï¼šQ/K/V/O åˆ‡ç‰‡èšåˆ  
âœ… **åä¾‹æ£€æµ‹**ï¼šimportant-but-static + plastic-but-unimportant  
âœ… **æ•°æ®æ±‡æ€»**ï¼šJSONL â†’ CSV + stats + cases  
âœ… **å¯è§†åŒ–**ï¼šä¸‰å¼ å›¾ï¼ˆmatplotlibï¼Œæ—  seabornï¼‰  

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. å·²æœ‰ä»£ç ä¿®æ­£ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

#### `src/train/finetune_glue.py`
- **ä¿®æ”¹**ï¼šBF16/FP16 è‡ªåŠ¨é€‰æ‹©é€»è¾‘
- **åŸå› **ï¼šç”¨æˆ·è¦æ±‚ä¼˜å…ˆ bf16ï¼Œå…¶æ¬¡ fp16ï¼Œå¦åˆ™ fp32
- **å®ç°**ï¼š
  ```python
  use_bf16 = False
  use_fp16 = False
  if torch.cuda.is_available():
      if torch.cuda.is_bf16_supported():
          use_bf16 = True
      else:
          use_fp16 = True
  ```

#### `src/analysis/make_subset.py`
- **ä¿®æ”¹**ï¼šé»˜è®¤ seed ä» 123 æ”¹ä¸º 999
- **åŸå› **ï¼šç”¨æˆ·è¦æ±‚å›ºå®š subset seed=999

### 2. æ–°å¢æ ¸å¿ƒæ–‡ä»¶

#### `src/data/glue.py` âœ¨
- **åŠŸèƒ½**ï¼šGLUE æ•°æ®åŠ è½½ä¸é¢„å¤„ç†
- **å…³é”®å®ç°**ï¼š
  - MNLI: `validation_matched` split
  - åŠ¨æ€ paddingï¼ˆcollate_fnï¼‰
  - æ”¯æŒ token_type_ids
  - eval_raw è¿”å› dict ä¾› Subset ä½¿ç”¨

#### `src/analysis/aggregate.py` âœ¨
- **åŠŸèƒ½**ï¼šJSONL â†’ CSV + stats + cases
- **å…³é”®å®ç°**ï¼š
  - Spearman ç›¸å…³ï¼ˆè‡ªå®ç°ï¼Œæ— éœ€ scipyï¼‰
  - Top-K overlapï¼ˆK=20ï¼‰
  - åä¾‹æ£€æµ‹ï¼ˆåˆ†ä½æ•°é˜ˆå€¼ï¼‰

#### `src/analysis/plots.py` âœ¨
- **åŠŸèƒ½**ï¼šç”Ÿæˆä¸‰å¼ å›¾
- **å…³é”®å®ç°**ï¼š
  - matplotlibï¼ˆæ—  seabornï¼‰
  - æ— é¢œè‰²æŒ‡å®šï¼ˆé»˜è®¤é…è‰²ï¼‰
  - ä¸åŒ marker æ ‡è®°åä¾‹

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### 1. DeBERTa æ¨¡å‹ç»“æ„å…¼å®¹
```
model.deberta.encoder.layer[i].attention.self  # DisentangledSelfAttention
â”œâ”€â”€ query_proj: Linear(hidden, hidden)
â”œâ”€â”€ key_proj: Linear(hidden, hidden)
â””â”€â”€ value_proj: Linear(hidden, hidden)

model.deberta.encoder.layer[i].attention.output.dense  # Linear(hidden, hidden)
```

### 2. Head Gate Hook
- æ³¨å†Œåœ¨ `attention.self` ä¸Š
- å¤„ç† tuple/list è¾“å‡ºï¼ˆå…¼å®¹ transformers 4.57.5ï¼‰
- Gate shape: [L, H]ï¼Œé»˜è®¤å…¨ 1

### 3. Head åˆ‡ç‰‡é€»è¾‘
- **Q/K/V**ï¼šåˆ‡åˆ† out_features ç»´åº¦ï¼ˆæ¯ä¸ª head äº§ç”Ÿ head_dim è¾“å‡ºï¼‰
- **O**ï¼šåˆ‡åˆ† in_features ç»´åº¦ï¼ˆæ··åˆæ‹¼æ¥åçš„ head è¾“å‡ºï¼‰

### 4. æ›´æ–°é‡è®¡ç®—
```python
U = sqrt(Uq^2 + Uk^2 + Uv^2 + Uo^2)
Urel = U / (||Wq0|| + ||Wk0|| + ||Wv0|| + ||Wo0||)
```

### 5. åä¾‹æ£€æµ‹é˜ˆå€¼
- **important-but-static**: I_pre â‰¥ p90 ä¸” Urel â‰¤ p30
- **plastic-but-unimportant**: Urel â‰¥ p90 ä¸” I_pre â‰¤ p30

---

## ğŸ“‹ ä½¿ç”¨æµç¨‹ï¼ˆä¸€é”®ä¸‰æ­¥ï¼‰

### æ­¥éª¤ 1ï¼šè®­ç»ƒï¼ˆ30-60 åˆ†é’Ÿï¼‰
```bash
bash scripts/run_mnli.sh 1
```
**è¾“å‡º**ï¼š
- `outputs/MNLI/seed1/ckpt_init/` (Î¸0)
- `outputs/MNLI/seed1/ckpt_final/` (Î¸1)

### æ­¥éª¤ 2ï¼šæµ‹é‡ï¼ˆ1-2 å°æ—¶ï¼‰
```bash
bash scripts/measure_mnli.sh 1
```
**è¾“å‡º**ï¼š
- `eval_subset.json` (1024 æ¡ï¼Œseed=999)
- `importance_pre.jsonl` (144 è¡Œ)
- `gradfisher_pre.jsonl` (144 è¡Œ)
- `update.jsonl` (144 è¡Œ)
- `importance_post.jsonl` (144 è¡Œ)

### æ­¥éª¤ 3ï¼šå¯è§†åŒ–ï¼ˆ< 1 åˆ†é’Ÿï¼‰
```bash
bash scripts/make_plots.sh 1
```
**è¾“å‡º**ï¼š
- `heads.csv` (144 è¡Œå®Œæ•´æŒ‡æ ‡)
- `stats.json` (Spearman Ï, top-K overlap, åä¾‹æ•°é‡)
- `cases.json` (ä¸¤ç±»åä¾‹é›†åˆ)
- `fig_I_vs_U.png` (æ•£ç‚¹å›¾ 1)
- `fig_I_vs_G.png` (æ•£ç‚¹å›¾ 2)
- `fig_stats.png` (ç»Ÿè®¡å›¾)

---

## âœ… éªŒæ”¶æ ‡å‡†ï¼ˆå¿…è¾¾ï¼‰

### æ•°æ®å®Œæ•´æ€§
- âœ“ heads.csv åŒ…å« 144 è¡Œï¼ˆ12Ã—12 headsï¼‰
- âœ“ æ‰€æœ‰ JSONL æ–‡ä»¶è¡Œæ•° = 144
- âœ“ cases.json åŒ…å«ä¸¤ç±»åä¾‹ï¼ˆéç©ºï¼‰

### æ•°å€¼åˆç†æ€§
- âœ“ Spearman Ï(I_pre, U) < 0.5ï¼ˆå¼±ç›¸å…³ï¼‰
- âœ“ Top-20 overlap < 0.3ï¼ˆtop head ä¸ä¸€è‡´ï¼‰
- âœ“ Important-but-static cases â‰¥ 3
- âœ“ Plastic-but-unimportant cases â‰¥ 3

### å¯è§†åŒ–è´¨é‡
- âœ“ ä¸‰å¼  PNG å›¾ç”ŸæˆæˆåŠŸ
- âœ“ æ•£ç‚¹å›¾ä¸­ä¸¤ç±»åä¾‹ç”¨ä¸åŒ marker æ ‡è®°
- âœ“ å›¾è¡¨ä½¿ç”¨é»˜è®¤ matplotlib é…è‰²

---

## ğŸ“š æ–‡æ¡£å®Œæ•´æ€§

### ä¸»æ–‡æ¡£
1. **README.md** (è¯¦å°½)
   - å¿«é€Ÿå¼€å§‹ï¼ˆä¸‰æ­¥å‘½ä»¤ï¼‰
   - è¾“å‡ºè¯´æ˜ï¼ˆå®Œæ•´è¡¨æ ¼ï¼‰
   - éªŒæ”¶æ ‡å‡†ï¼ˆæ•°å€¼ + å¯è§†åŒ–ï¼‰
   - å¸¸è§é—®é¢˜æ’æŸ¥ï¼ˆ6 ä¸ªåœºæ™¯ï¼‰
   - æŠ€æœ¯ç»†èŠ‚ï¼ˆæ¨¡å‹ç»“æ„ã€åˆ‡ç‰‡é€»è¾‘ã€å…¬å¼ï¼‰

2. **QUICKSTART.md** (å®ç”¨)
   - ä¸€é”®å‘½ä»¤
   - é¢„æœŸè¾“å‡ºç¤ºä¾‹
   - å¤šç§å­å®éªŒ
   - è°ƒè¯•æŠ€å·§

3. **CHECKLIST.md** (å…¨é¢)
   - æ–‡ä»¶æ¸…å•ï¼ˆ26 ä¸ªæ–‡ä»¶ï¼Œé€ä¸€å‹¾é€‰ï¼‰
   - åŠŸèƒ½éªŒè¯ï¼ˆæ•°æ®ã€æ¨¡å‹ã€è®­ç»ƒã€æµ‹é‡ã€åˆ†æï¼‰
   - æµ‹è¯•æ­¥éª¤ï¼ˆç¯å¢ƒã€è®­ç»ƒã€æµ‹é‡ã€å¯è§†åŒ–ï¼‰
   - å¸¸è§é™·é˜±å·²è§„é¿ï¼ˆ7 é¡¹ï¼‰

4. **PROJECT_FILES.md** (æ¸…æ™°)
   - å®Œæ•´æ–‡ä»¶åˆ—è¡¨ï¼ˆ26 ä¸ªï¼‰
   - æ¯ä¸ªæ–‡ä»¶çš„ç”¨é€”è¯´æ˜
   - æ–‡ä»¶çŠ¶æ€æ ‡æ³¨ï¼ˆâœ… å·²æœ‰ / âœ¨ æ–°å¢ï¼‰
   - è¾“å‡ºæ–‡ä»¶è¯´æ˜ï¼ˆ15 ä¸ªæ–‡ä»¶ï¼‰

### é…ç½®ä¸å·¥å…·
5. **requirements.txt** - ç²¾ç¡®ä¾èµ–ç‰ˆæœ¬
6. **configs/mnli.yaml** - å‚è€ƒé…ç½®
7. **test_setup.py** - ç¯å¢ƒæµ‹è¯•ï¼ˆ5 æ­¥éªŒè¯ï¼‰
8. **.gitignore** - Git è§„åˆ™

---

## ğŸ” è´¨é‡ä¿è¯

### ä»£ç è´¨é‡
- âœ… æ‰€æœ‰ Python åŒ…å¯å¯¼å…¥ï¼ˆå·²æµ‹è¯•ï¼‰
- âœ… æ¨¡å—è·¯å¾„æ­£ç¡®ï¼ˆä½¿ç”¨ `python -m`ï¼‰
- âœ… å‡½æ•°ç­¾åä¸€è‡´ï¼ˆä¸ç”¨æˆ·å·²æœ‰ä»£ç å…¼å®¹ï¼‰
- âœ… é”™è¯¯å¤„ç†å®Œå–„ï¼ˆæ–‡ä»¶ç¼ºå¤±ã€æ•°æ®éªŒè¯ï¼‰

### å…¼å®¹æ€§
- âœ… transformers 4.57.5ï¼ˆhook è¿”å› tuple/list å¤„ç†ï¼‰
- âœ… datasets 4.4.2ï¼ˆåœ¨çº¿åŠ è½½ GLUEï¼‰
- âœ… torch 2.9.1ï¼ˆBF16/FP16 æ£€æµ‹ï¼‰
- âœ… æ—  scipy ä¾èµ–ï¼ˆSpearman è‡ªå®ç°ï¼‰

### å¥å£®æ€§
- âœ… Gate hook æœªç”Ÿæ•ˆæ£€æµ‹ï¼ˆsanity checkï¼‰
- âœ… View/reshape æŠ¥é”™é¢„é˜²ï¼ˆshape éªŒè¯ï¼‰
- âœ… MNLI split æ­£ç¡®ï¼ˆvalidation_matchedï¼‰
- âœ… BF16/FP16 è‡ªåŠ¨å›é€€ï¼ˆä¸‰çº§åˆ¤æ–­ï¼‰

---

## ğŸ“ é¡¹ç›®äº®ç‚¹

### 1. æœ€å°æ”¹åŠ¨åŸåˆ™
- ç”¨æˆ·å·²æœ‰ä»£ç ä»…ä¿®æ”¹ 2 å¤„ï¼ˆæœ€å°å¿…è¦æ”¹åŠ¨ï¼‰
- ä¿æŒå‡½æ•°åã€ç±»åã€æ¥å£ä¸€è‡´
- è¡¥é½ç¼ºå¤±åŠŸèƒ½è€Œéé‡å†™

### 2. ä¸€é”®å¯è¿è¡Œ
- ä¸‰æ¡å‘½ä»¤è·‘é€šå®Œæ•´æµç¨‹
- è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜ï¼ˆeval size è‡ªåŠ¨è·å–ï¼‰
- é”™è¯¯æç¤ºæ¸…æ™°ï¼ˆç¼ºæ–‡ä»¶åˆ™æç¤ºå…ˆè¿è¡Œå‰ç½®æ­¥éª¤ï¼‰

### 3. æ–‡æ¡£è¯¦å°½
- 4 ä¸ªæ–‡æ¡£æ–‡ä»¶ï¼Œäº’ç›¸è¡¥å……
- è¦†ç›–å¿«é€Ÿå¼€å§‹ã€æŠ€æœ¯ç»†èŠ‚ã€æ’æŸ¥é—®é¢˜
- é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼ˆJSON æ ¼å¼å±•ç¤ºï¼‰

### 4. éªŒæ”¶æ˜ç¡®
- æ•°å€¼æ ‡å‡†ï¼ˆSpearman < 0.5, overlap < 0.3ï¼‰
- åä¾‹æ•°é‡ï¼ˆâ‰¥3 ä¸ªï¼‰
- å¯è§†åŒ–è¦æ±‚ï¼ˆä¸åŒ markerï¼Œæ— é¢œè‰²æŒ‡å®šï¼‰

### 5. å¯æ‰©å±•æ€§
- æ”¯æŒå¤š GLUE ä»»åŠ¡ï¼ˆå·²æœ‰ RTE é…ç½®ï¼‰
- æ”¯æŒå¤šç§å­å®éªŒï¼ˆè„šæœ¬ä¼ å‚ï¼‰
- é…ç½®æ–‡ä»¶é¢„ç•™ï¼ˆyamlï¼Œè™½æœªä½¿ç”¨ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯æ‰§è¡Œ
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /data1/shenth/work/MI_plasticity/minimal-exp

# æµ‹è¯•ç¯å¢ƒï¼ˆæ¨èï¼‰
python test_setup.py

# è¿è¡Œå®Œæ•´å®éªŒ
bash scripts/run_mnli.sh 1      # è®­ç»ƒ
bash scripts/measure_mnli.sh 1  # æµ‹é‡
bash scripts/make_plots.sh 1    # å¯è§†åŒ–
```

### æŸ¥çœ‹ç»“æœ
```bash
# æŸ¥çœ‹ç»Ÿè®¡æŒ‡æ ‡
cat outputs/MNLI/seed1/stats.json

# æŸ¥çœ‹åä¾‹é›†åˆ
cat outputs/MNLI/seed1/cases.json

# æŸ¥çœ‹å®Œæ•´æ•°æ®
head -20 outputs/MNLI/seed1/heads.csv
```

### å¤šç§å­å®éªŒï¼ˆå¯é€‰ï¼‰
```bash
for seed in 1 2 3 4 5; do
    bash scripts/run_mnli.sh $seed
    bash scripts/measure_mnli.sh $seed
    bash scripts/make_plots.sh $seed
done
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### é‡åˆ°é—®é¢˜ï¼Ÿ

1. **æŸ¥é˜…æ–‡æ¡£**
   - README.md Â§ å¸¸è§é—®é¢˜æ’æŸ¥
   - QUICKSTART.md Â§ è°ƒè¯•æŠ€å·§
   - CHECKLIST.md Â§ æµ‹è¯•æ­¥éª¤

2. **è¿è¡Œæµ‹è¯•**
   ```bash
   python test_setup.py  # 5 æ­¥ç¯å¢ƒéªŒè¯
   ```

3. **æ£€æŸ¥è¾“å‡º**
   ```bash
   # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
   ls outputs/MNLI/seed1/*.jsonl  # åº”æœ‰ 4 ä¸ªæ–‡ä»¶
   wc -l outputs/MNLI/seed1/*.jsonl  # æ¯ä¸ªåº”æœ‰ 144 è¡Œ
   ```

---

## ğŸ‰ æ€»ç»“

âœ… **é¡¹ç›®çŠ¶æ€**ï¼šå®Œå…¨å°±ç»ªï¼Œå¯ç«‹å³è¿è¡Œ  
âœ… **æ–‡ä»¶å®Œæ•´**ï¼š26 ä¸ªæ–‡ä»¶ï¼Œå…¨éƒ¨ç”Ÿæˆ  
âœ… **æ–‡æ¡£è¯¦å°½**ï¼š4 ä¸ªæ–‡æ¡£ï¼Œè¦†ç›–æ‰€æœ‰åœºæ™¯  
âœ… **éªŒæ”¶æ˜ç¡®**ï¼šæ•°å€¼æ ‡å‡† + åä¾‹é›†åˆ + å¯è§†åŒ–  
âœ… **å¥å£®æ€§é«˜**ï¼šé”™è¯¯å¤„ç† + å…¼å®¹æ€§ + è‡ªåŠ¨åŒ–  

**æ‚¨ç°åœ¨å¯ä»¥å¼€å§‹å®éªŒäº†ï¼**

---

**ç”Ÿæˆæ—¶é—´**ï¼š2026-01-16  
**ç”Ÿæˆå·¥å…·**ï¼šCursor AI (Claude Sonnet 4.5)  
**é¡¹ç›®è·¯å¾„**ï¼š`/data1/shenth/work/MI_plasticity/minimal-exp`  
**é¢„æœŸè¿è¡Œæ—¶é—´**ï¼š2-3 å°æ—¶ï¼ˆè®­ç»ƒ + æµ‹é‡ + å¯è§†åŒ–ï¼‰

ç¥å®éªŒé¡ºåˆ©ï¼ğŸ¯
